// Party Carpool Application
let map;
let markers = [];
let eventMarker = null; // Track event marker separately
let eventData = {};
let currentEventId = 1;

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    loadEventData();
    loadUsers();
    loadCarpools();
    setupEventListeners();
    setInterval(refreshData, 30000); // Refresh every 30 seconds
});

// Initialize Leaflet Map
function initMap() {
    // Initialize empty map centered on Madison
    map = L.map('map').setView([43.0731, -89.4012], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
}

// Load event data
async function loadEventData() {
    try {
        const response = await fetch(`/api/events.php?id=${currentEventId}`);
        const data = await response.json();
        eventData = data;

        // Update event header - show message if event details not complete
        if (data.event_name && data.event_address) {
            document.getElementById('eventName').textContent = data.event_name;
            document.getElementById('eventDateTime').textContent =
                new Date(data.event_date + ' ' + data.event_time).toLocaleString();
            document.getElementById('eventLocation').textContent = data.event_address;
        } else {
            document.getElementById('eventName').textContent = 'Event Details Not Set';
            document.getElementById('eventDateTime').textContent = 'Admin needs to configure event';
            document.getElementById('eventLocation').textContent = 'Please contact admin';
        }

        // Update participation stats with correct data
        document.getElementById('totalRegistered').textContent = data.total_participants || 0;
        document.getElementById('availableSeats').textContent = data.total_vehicle_capacity || 0;
        document.getElementById('driverCount').textContent = data.total_drivers || 0;
        document.getElementById('optimizationStatus').textContent = data.optimization_status === 'completed' ? 'Completed' : 'Pending';

        // Add event marker to map with pulsing animation
        if (data.event_lat && data.event_lng) {
            // Remove old event marker if it exists
            if (eventMarker && map.hasLayer(eventMarker)) {
                map.removeLayer(eventMarker);
            }

            // Create new event marker
            eventMarker = L.marker([parseFloat(data.event_lat), parseFloat(data.event_lng)], {
                icon: L.divIcon({
                    html: '<i class="fas fa-star"></i>',
                    iconSize: [48, 48],
                    className: 'custom-marker event-marker',
                    iconAnchor: [24, 24],
                    popupAnchor: [0, -24]
                })
            }).addTo(map);

            eventMarker.bindPopup(`
                <div class="popup-header" style="font-size: 1.2rem; color: #FF8C00;">
                    <i class="fas fa-star"></i> Party Location!
                </div>
                <div class="popup-info"><i class="fas fa-calendar"></i> <strong>${data.event_name}</strong></div>
                <div class="popup-info"><i class="fas fa-map-marker"></i> ${data.event_address}</div>
                <div class="popup-info"><i class="fas fa-clock"></i> ${new Date(data.event_date + ' ' + data.event_time).toLocaleString()}</div>
            `);

            // Store event location for later use
            eventData.event_lat = parseFloat(data.event_lat);
            eventData.event_lng = parseFloat(data.event_lng);

            // Only center on first load, not on refresh
            if (!window.mapInitialized) {
                map.setView([eventData.event_lat, eventData.event_lng], 13);
                window.mapInitialized = true;
            }
        } else {
            // No location set - show message on map
            const messageDiv = document.createElement('div');
            messageDiv.id = 'noLocationMessage';
            messageDiv.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); text-align: center;';
            messageDiv.innerHTML = `
                <i class="fas fa-map-marked-alt" style="font-size: 48px; color: #ccc; margin-bottom: 10px;"></i>
                <h5>Party Location Not Set</h5>
                <p class="text-muted mb-0">The admin has not yet set the party destination location.</p>
            `;
            document.getElementById('map').appendChild(messageDiv);
        }

    } catch (error) {
        console.error('Error loading event data:', error);
    }
}

// Load all users
async function loadUsers() {
    try {
        const response = await fetch(`/api/users.php?event_id=${currentEventId}`);
        const users = await response.json();

        // Clear existing user markers (but not event marker)
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        // Remove "no location" message if it exists
        const noLocationMsg = document.getElementById('noLocationMessage');
        if (noLocationMsg) {
            noLocationMsg.remove();
        }

        // Separate willing drivers and those needing rides for map display
        const drivers = users.filter(u => u.willing_to_drive);
        const riders = users.filter(u => !u.willing_to_drive);

        let totalSeats = 0;

        // Add driver markers to map with cute styling
        drivers.forEach(driver => {
            if (driver.lat && driver.lng) {
                const driverMarker = L.marker([driver.lat, driver.lng], {
                    icon: L.divIcon({
                        html: '<i class="fas fa-car"></i>',
                        iconSize: [36, 36],
                        className: 'custom-marker driver-marker',
                        iconAnchor: [18, 18],
                        popupAnchor: [0, -18]
                    })
                }).addTo(map);

                driverMarker.bindPopup(`
                    <div class="popup-header" style="color: #28a745;">
                        <i class="fas fa-car"></i> ${driver.name}
                    </div>
                    <div class="badge bg-success mb-2">Willing to Drive</div>
                    <div class="popup-info"><i class="fas fa-envelope"></i> ${driver.email}</div>
                    <div class="popup-info"><i class="fas fa-phone"></i> ${driver.phone || 'N/A'}</div>
                    <div class="popup-info"><i class="fas fa-chair"></i> <strong>${driver.vehicle_capacity || 4} total seats</strong></div>
                    ${driver.vehicle_make ? `<div class="popup-info"><i class="fas fa-car-side"></i> ${driver.vehicle_make} ${driver.vehicle_model || ''}</div>` : ''}
                    <div class="popup-info"><i class="fas fa-home"></i> ${driver.address || 'Madison, WI'}</div>
                `);

                markers.push(driverMarker);
            }

            totalSeats += parseInt(driver.vehicle_capacity) || 0;
        });

        document.getElementById('availableSeats').textContent = totalSeats;

        // Add rider markers to map with cute styling
        riders.forEach(rider => {
            if (rider.lat && rider.lng) {
                const riderMarker = L.marker([rider.lat, rider.lng], {
                    icon: L.divIcon({
                        html: '<i class="fas fa-user-friends"></i>',
                        iconSize: [36, 36],
                        className: 'custom-marker rider-marker',
                        iconAnchor: [18, 18],
                        popupAnchor: [0, -18]
                    })
                }).addTo(map);

                riderMarker.bindPopup(`
                    <div class="popup-header" style="color: #17a2b8;">
                        <i class="fas fa-user-friends"></i> ${rider.name}
                    </div>
                    <div class="badge bg-info mb-2">Needs a Ride</div>
                    <div class="popup-info"><i class="fas fa-envelope"></i> ${rider.email}</div>
                    <div class="popup-info"><i class="fas fa-phone"></i> ${rider.phone || 'N/A'}</div>
                    <div class="popup-info"><i class="fas fa-home"></i> ${rider.address || 'Madison, WI'}</div>
                    ${rider.special_notes ? `<div class="popup-info"><i class="fas fa-comment"></i> ${rider.special_notes}</div>` : ''}
                `);

                markers.push(riderMarker);
            }
        });

        // Update stats chart
        updateStatsChart(drivers.length, riders.length);

        // Always ensure party location is shown if it exists
        if (eventData.event_lat && eventData.event_lng) {
            // Make sure event marker exists and is on the map
            if (!eventMarker || !map.hasLayer(eventMarker)) {
                eventMarker = L.marker([eventData.event_lat, eventData.event_lng], {
                    icon: L.divIcon({
                        html: '<i class="fas fa-star"></i>',
                        iconSize: [48, 48],
                        className: 'custom-marker event-marker',
                        iconAnchor: [24, 24],
                        popupAnchor: [0, -24]
                    })
                }).addTo(map);

                eventMarker.bindPopup(`
                    <div class="popup-header" style="font-size: 1.2rem; color: #FF8C00;">
                        <i class="fas fa-star"></i> Party Location!
                    </div>
                    <div class="popup-info"><i class="fas fa-calendar"></i> <strong>${eventData.event_name}</strong></div>
                    <div class="popup-info"><i class="fas fa-map-marker"></i> ${eventData.event_address}</div>
                    <div class="popup-info"><i class="fas fa-clock"></i> ${new Date(eventData.event_date + ' ' + eventData.event_time).toLocaleString()}</div>
                `);
            }

            // Fit bounds to show all markers
            if (markers.length > 0 || eventMarker) {
                const allMarkersToShow = [...markers];
                if (eventMarker) {
                    allMarkersToShow.push(eventMarker);
                }
                const group = new L.featureGroup(allMarkersToShow);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

    } catch (error) {
        console.error('Error loading users:', error);
    }
}

// Load carpool matches (simplified for stats only)
async function loadCarpools() {
    // This function is kept minimal since we removed the matches display
    // It can be extended later if needed for other purposes
    try {
        const response = await fetch(`/api/carpools.php?event_id=${currentEventId}`);
        const carpools = await response.json();
        // Could update optimization status here if needed
    } catch (error) {
        console.error('Error loading carpools:', error);
    }
}

// Setup event listeners
function setupEventListeners() {
    // Willing to drive change
    document.getElementById('willingToDrive').addEventListener('change', function() {
        const driverFields = document.getElementById('driverFields');
        if (this.value === 'true') {
            driverFields.style.display = 'block';
        } else {
            driverFields.style.display = 'none';
        }
    });

    // Registration form
    document.getElementById('registrationForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const willing = document.getElementById('willingToDrive').value === 'true';

        // Validate vehicle capacity if willing to drive
        if (willing) {
            const seats = document.getElementById('availableSeatsInput').value;
            if (!seats || seats < 1 || seats > 12) {
                showAlert('Please enter the number of available seats for passengers (1-12)', 'warning');
                document.getElementById('availableSeatsInput').focus();
                return;
            }
        }

        // Geocode the address automatically
        const address = document.getElementById('address').value;
        let lat = null, lng = null;

        try {
            const geoResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
            const geoData = await geoResponse.json();
            if (geoData && geoData.length > 0) {
                lat = parseFloat(geoData[0].lat);
                lng = parseFloat(geoData[0].lon);
            }
        } catch (error) {
            console.error('Geocoding error:', error);
        }

        const formData = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            willing_to_drive: willing,
            address: address,
            lat: lat,
            lng: lng,
            event_id: currentEventId,
            special_notes: document.getElementById('driverNotes')?.value || ''
        };

        if (willing) {
            formData.vehicle_capacity = parseInt(document.getElementById('availableSeatsInput').value);
            formData.vehicle_make = document.getElementById('carMake').value;
            formData.vehicle_model = document.getElementById('carModel').value;
            formData.vehicle_color = document.getElementById('carColor').value;
        }

        try {
            const response = await fetch('/api/users.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (response.ok) {
                showAlert('Registration successful!', 'success');
                document.getElementById('registrationForm').reset();
                loadUsers();
                showSection('home');
            } else {
                showAlert(result.message || 'Registration failed', 'danger');
            }
        } catch (error) {
            showAlert('Error during registration', 'danger');
            console.error('Registration error:', error);
        }
    });
}


// Request ride from driver
function requestRide(driverId) {
    document.getElementById('modalDriverId').value = driverId;
    const modal = new bootstrap.Modal(document.getElementById('requestRideModal'));
    modal.show();
}

// Submit ride request
async function submitRideRequest() {
    const driverId = document.getElementById('modalDriverId').value;
    const riderEmail = document.getElementById('modalRiderEmail').value;

    // First, find or create the rider
    const usersResponse = await fetch(`/api/users.php?event_id=${currentEventId}`);
    const users = await usersResponse.json();
    const rider = users.find(u => u.email === riderEmail && u.user_type === 'rider');

    if (!rider) {
        showAlert('Please register as a rider first', 'warning');
        return;
    }

    const carpoolData = {
        driver_id: driverId,
        rider_id: rider.id,
        event_id: currentEventId,
        pickup_address: document.getElementById('modalPickupAddress').value,
        pickup_time: document.getElementById('modalPickupTime').value,
        notes: document.getElementById('modalNotes').value,
        status: 'pending'
    };

    try {
        const response = await fetch('/api/carpools.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(carpoolData)
        });

        const result = await response.json();

        if (response.ok) {
            showAlert('Ride request sent successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('requestRideModal')).hide();
            document.getElementById('requestRideForm').reset();
            loadCarpools();
        } else {
            showAlert(result.message || 'Failed to request ride', 'danger');
        }
    } catch (error) {
        showAlert('Error requesting ride', 'danger');
        console.error('Request ride error:', error);
    }
}

// Update carpool status
async function updateCarpoolStatus(carpoolId, status) {
    try {
        const response = await fetch(`/api/carpools.php?id=${carpoolId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: status })
        });

        if (response.ok) {
            showAlert(`Carpool ${status}!`, 'success');
            loadCarpools();
            loadEventData();
        } else {
            showAlert('Failed to update carpool status', 'danger');
        }
    } catch (error) {
        showAlert('Error updating carpool', 'danger');
        console.error('Update carpool error:', error);
    }
}

// Show different sections
function showSection(section) {
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.style.display = 'none';
    });

    // Show selected section
    document.getElementById(section + 'Section').style.display = 'block';

    // Update active nav link
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    event.target?.classList.add('active');

    // Invalidate map size if showing home
    if (section === 'home') {
        setTimeout(() => map.invalidateSize(), 100);
    }
}

// Update stats chart
function updateStatsChart(drivers, riders) {
    const ctx = document.getElementById('statsChart');
    if (!ctx) return;

    if (window.statsChart) {
        window.statsChart.destroy();
    }

    window.statsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Drivers', 'Riders'],
            datasets: [{
                data: [drivers, riders],
                backgroundColor: ['#28a745', '#17a2b8'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Show alert messages
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Refresh data
function refreshData() {
    loadEventData();
    loadUsers();
    loadCarpools();
}

// Offer ride to a rider (for drivers)
async function offerRide(riderId) {
    const driverEmail = prompt('Please enter your email (you must be registered as a driver):');
    if (!driverEmail) return;

    const usersResponse = await fetch(`/api/users.php?event_id=${currentEventId}`);
    const users = await usersResponse.json();
    const driver = users.find(u => u.email === driverEmail && u.user_type === 'driver');

    if (!driver) {
        showAlert('You must be registered as a driver to offer rides', 'warning');
        return;
    }

    const carpoolData = {
        driver_id: driver.id,
        rider_id: riderId,
        event_id: currentEventId,
        status: 'pending'
    };

    try {
        const response = await fetch('/api/carpools.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(carpoolData)
        });

        const result = await response.json();

        if (response.ok) {
            showAlert('Ride offer sent successfully!', 'success');
            loadCarpools();
        } else {
            showAlert(result.message || 'Failed to offer ride', 'danger');
        }
    } catch (error) {
        showAlert('Error offering ride', 'danger');
        console.error('Offer ride error:', error);
    }
}