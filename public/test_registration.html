<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Registration - Vehicle Capacity</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Test Vehicle Registration</h2>
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> This page tests the vehicle capacity field
        </div>

        <div class="card">
            <div class="card-body">
                <form id="testForm">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" value="Test User" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Are you willing to drive?</label>
                        <select class="form-select" id="willing" required>
                            <option value="">Select...</option>
                            <option value="true">Yes, I can drive</option>
                            <option value="false">No, I need a ride</option>
                        </select>
                    </div>

                    <div id="vehicleInfo" style="display: none;" class="border rounded p-3 mb-3">
                        <h5 class="text-primary">Vehicle Information</h5>
                        <div class="mb-3">
                            <label class="form-label">Total Seats in Your Car *</label>
                            <input type="number" class="form-control" id="seats" min="1" max="8" value="4">
                            <small class="text-muted">Including the driver seat</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vehicle Make</label>
                            <input type="text" class="form-control" id="make" placeholder="e.g., Toyota">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vehicle Model</label>
                            <input type="text" class="form-control" id="model" placeholder="e.g., Camry">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Register
                    </button>
                </form>

                <div id="result" class="mt-3"></div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Current Participants</div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Willing to Drive</th>
                            <th>Vehicle Capacity</th>
                            <th>Vehicle</th>
                        </tr>
                    </thead>
                    <tbody id="usersList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Handle willing to drive change
        document.getElementById('willing').addEventListener('change', function() {
            const vehicleInfo = document.getElementById('vehicleInfo');
            if (this.value === 'true') {
                vehicleInfo.style.display = 'block';
                document.getElementById('seats').required = true;
            } else {
                vehicleInfo.style.display = 'none';
                document.getElementById('seats').required = false;
            }
        });

        // Handle form submission
        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const willing = document.getElementById('willing').value === 'true';
            const email = 'test' + Date.now() + '@example.com';

            const data = {
                name: document.getElementById('name').value,
                email: email,
                willing_to_drive: willing,
                event_id: 1,
                address: '123 Test St, LA, CA'
            };

            if (willing) {
                data.vehicle_capacity = parseInt(document.getElementById('seats').value);
                data.vehicle_make = document.getElementById('make').value;
                data.vehicle_model = document.getElementById('model').value;
            }

            try {
                const response = await fetch('/api/users.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('result').innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check"></i> ${result.message}
                            <br>Email: ${email}
                            ${willing ? '<br>Vehicle Capacity: ' + data.vehicle_capacity + ' seats' : ''}
                        </div>
                    `;
                    loadUsers();
                } else {
                    document.getElementById('result').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times"></i> ${result.message}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('result').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times"></i> Error: ${error.message}
                    </div>
                `;
            }
        });

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/api/users.php?event_id=1');
                const users = await response.json();

                const tbody = document.getElementById('usersList');
                tbody.innerHTML = '';

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>
                            ${user.willing_to_drive ?
                                '<span class="badge bg-success">Yes</span>' :
                                '<span class="badge bg-secondary">No</span>'
                            }
                        </td>
                        <td>
                            ${user.vehicle_capacity ?
                                '<span class="badge bg-primary">' + user.vehicle_capacity + ' seats</span>' :
                                '-'
                            }
                        </td>
                        <td>${user.vehicle_make || ''} ${user.vehicle_model || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load on page load
        loadUsers();
    </script>
</body>
</html>