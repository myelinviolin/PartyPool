<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Optimization Test</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-4">
        <h2>Complete Optimization Debugging</h2>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h5>1. Test Session Status</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testSession()">Test Session</button>
                        <pre id="sessionResult" class="mt-3 p-2 bg-light" style="display:none;"></pre>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-warning text-dark">
                        <h5>2. Test Without Auth</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-warning" onclick="testNoAuth()">Test No Auth</button>
                        <pre id="noAuthResult" class="mt-3 p-2 bg-light" style="display:none;"></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h5>3. Test Main Optimization</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-success" onclick="testMain()">Test Main Optimization</button>
                <div id="mainStatus" class="mt-3"></div>
                <pre id="mainResult" class="mt-3 p-2 bg-light" style="display:none;"></pre>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5>4. Direct PHP Test</h5>
            </div>
            <div class="card-body">
                <p>Click these links to test PHP files directly:</p>
                <ul>
                    <li><a href="test_session.php" target="_blank">test_session.php</a> - Check session and database</li>
                    <li><a href="optimize_test_no_auth.php" target="_blank">optimize_test_no_auth.php</a> - Test without authentication</li>
                    <li><a href="optimize_enhanced_debug.php" target="_blank">optimize_enhanced_debug.php</a> - Debug version</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        async function testSession() {
            const resultDiv = document.getElementById('sessionResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Loading...';

            try {
                const response = await fetch('test_session.php', {
                    credentials: 'same-origin'
                });
                const text = await response.text();

                try {
                    const json = JSON.parse(text);
                    resultDiv.textContent = JSON.stringify(json, null, 2);
                } catch (e) {
                    resultDiv.textContent = 'Raw response:\n' + text;
                }
            } catch (error) {
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }

        async function testNoAuth() {
            const resultDiv = document.getElementById('noAuthResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Loading...';

            try {
                const response = await fetch('optimize_test_no_auth.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        event_id: 1,
                        target_vehicles: null,
                        max_drive_time: 50
                    })
                });
                const text = await response.text();

                try {
                    const json = JSON.parse(text);
                    resultDiv.textContent = JSON.stringify(json, null, 2);
                } catch (e) {
                    resultDiv.textContent = 'Raw response:\n' + text;
                }
            } catch (error) {
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }

        async function testMain() {
            const statusDiv = document.getElementById('mainStatus');
            const resultDiv = document.getElementById('mainResult');

            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Testing...';
            resultDiv.style.display = 'none';

            try {
                const response = await fetch('optimize_enhanced.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        event_id: 1,
                        target_vehicles: null,
                        max_drive_time: 50
                    })
                });

                const text = await response.text();
                console.log('Raw response:', text);
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                resultDiv.style.display = 'block';

                if (text === '') {
                    statusDiv.innerHTML = '<div class="alert alert-danger">❌ Empty response received</div>';
                    resultDiv.textContent = 'Response was empty.\n\nPossible causes:\n' +
                        '1. PHP fatal error\n' +
                        '2. Session not set (not logged in)\n' +
                        '3. Include path issues\n\n' +
                        'Check browser console for more details.';
                    return;
                }

                try {
                    const json = JSON.parse(text);
                    if (json.success) {
                        statusDiv.innerHTML = '<div class="alert alert-success">✅ Optimization successful!</div>';
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-warning">⚠️ ' + json.message + '</div>';
                    }
                    resultDiv.textContent = JSON.stringify(json, null, 2);
                } catch (e) {
                    statusDiv.innerHTML = '<div class="alert alert-danger">❌ Invalid JSON</div>';
                    resultDiv.textContent = 'JSON parse error: ' + e.message + '\n\nRaw response:\n' + text;
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger">❌ Network error</div>';
                resultDiv.style.display = 'block';
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }
    </script>
</body>
</html>