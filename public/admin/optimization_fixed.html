<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Optimization Fixed!</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container mt-4">
        <div class="alert alert-success">
            <h4 class="alert-heading">‚úÖ Optimization Error Fixed!</h4>
            <p>The 500 error has been resolved. The optimization should now work correctly.</p>
        </div>

        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-check-circle"></i> What Was Fixed</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>Clustering Algorithm:</strong> Fixed logic error that was causing count() on null value</li>
                    <li><strong>Minimum Vehicles Calculation:</strong> Corrected initialization value</li>
                    <li><strong>Error Handling:</strong> Added checks for empty driver arrays</li>
                </ul>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-key"></i> Important: Login Required</h5>
            </div>
            <div class="card-body">
                <p>Remember, you must be logged in as admin for the optimization to work:</p>
                <ol>
                    <li>Go to <a href="login.php" target="_blank">Admin Login</a></li>
                    <li>Login with:
                        <ul>
                            <li>Username: <strong>admin</strong></li>
                            <li>Password: <strong>admin123</strong></li>
                        </ul>
                    </li>
                    <li>Then go to <a href="dashboard.php" target="_blank">Admin Dashboard</a></li>
                    <li>Click "Run Optimization"</li>
                </ol>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-flask"></i> Test the Fix</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-success mb-3" onclick="testOptimization()">
                    <i class="fas fa-play"></i> Test Optimization Now
                </button>
                <div id="status"></div>
                <pre id="result" class="bg-light p-3 mt-3" style="display:none;"></pre>
            </div>
        </div>
    </div>

    <script>
        async function testOptimization() {
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result');

            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Testing optimization...';
            resultDiv.style.display = 'none';

            // First set session
            await fetch('set_test_session.php', { credentials: 'same-origin' });

            // Then test optimization
            try {
                const response = await fetch('optimize_enhanced.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        event_id: 1,
                        target_vehicles: null,
                        max_drive_time: 50
                    })
                });

                const text = await response.text();
                console.log('Response:', text);

                try {
                    const result = JSON.parse(text);
                    if (result.success) {
                        statusDiv.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check"></i> <strong>Success!</strong><br>
                                ‚úÖ Optimization completed successfully<br>
                                üìä ${result.total_participants || 0} participants optimized<br>
                                üöó ${result.vehicles_needed || 0} vehicles needed
                            </div>
                        `;
                        resultDiv.style.display = 'block';
                        resultDiv.textContent = JSON.stringify(result, null, 2);
                    } else {
                        statusDiv.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è ${result.message}</div>`;
                        resultDiv.style.display = 'block';
                        resultDiv.textContent = JSON.stringify(result, null, 2);
                    }
                } catch (e) {
                    statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå JSON Error: ${e.message}</div>`;
                    resultDiv.style.display = 'block';
                    resultDiv.textContent = 'Raw response:\n' + text;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Network Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>