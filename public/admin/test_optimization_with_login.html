<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimization Test with Login</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container mt-4">
        <h2>Optimization Test with Session Setup</h2>

        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>The issue:</strong> You need to be logged in as admin for optimization to work.
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5>Step 1: Set Test Session</h5>
                    </div>
                    <div class="card-body">
                        <p>This will set a temporary admin session for testing:</p>
                        <button class="btn btn-primary" onclick="setSession()">
                            <i class="fas fa-user-lock"></i> Set Admin Session
                        </button>
                        <div id="sessionStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5>Step 2: Test Optimization</h5>
                    </div>
                    <div class="card-body">
                        <p>After setting session, test the optimization:</p>
                        <button class="btn btn-success" onclick="testOptimization()" id="testBtn" disabled>
                            <i class="fas fa-play"></i> Run Optimization
                        </button>
                        <div id="optimizationStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5>Results</h5>
            </div>
            <div class="card-body">
                <pre id="results" class="bg-light p-3" style="display:none;"></pre>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-warning text-dark">
                <h5>Alternative: Login Properly</h5>
            </div>
            <div class="card-body">
                <p>For the real dashboard to work, you need to be logged in:</p>
                <a href="login.php" class="btn btn-warning">
                    <i class="fas fa-sign-in-alt"></i> Go to Login Page
                </a>
                <p class="mt-2 text-muted">
                    Default credentials: admin / admin123
                </p>
            </div>
        </div>
    </div>

    <script>
        async function setSession() {
            const statusDiv = document.getElementById('sessionStatus');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Setting session...';

            try {
                const response = await fetch('set_test_session.php', {
                    credentials: 'same-origin'
                });
                const result = await response.json();

                if (result.session_set) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check"></i> Session set successfully!<br>
                            Session ID: ${result.session_id}<br>
                            Admin ID: ${result.admin_id}<br>
                            Database: ${result.database_connected ? '✅ Connected' : '❌ Not connected'}
                        </div>
                    `;
                    document.getElementById('testBtn').disabled = false;
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-danger">Failed to set session</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }

        async function testOptimization() {
            const statusDiv = document.getElementById('optimizationStatus');
            const resultsDiv = document.getElementById('results');

            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Running optimization...';
            resultsDiv.style.display = 'none';

            try {
                const response = await fetch('optimize_enhanced.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        event_id: 1,
                        target_vehicles: null,
                        max_drive_time: 50
                    })
                });

                const text = await response.text();
                console.log('Raw response:', text);

                resultsDiv.style.display = 'block';

                if (text === '') {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> Empty response received<br>
                            <small>This usually means you're not logged in. Try Step 1 first or login properly.</small>
                        </div>
                    `;
                    resultsDiv.textContent = 'No response from server';
                    return;
                }

                try {
                    const result = JSON.parse(text);
                    if (result.success) {
                        statusDiv.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check"></i> Optimization successful!<br>
                                Participants: ${result.total_participants || 0}<br>
                                Vehicles needed: ${result.vehicles_needed || 0}
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation"></i> ${result.message}
                            </div>
                        `;
                    }
                    resultsDiv.textContent = JSON.stringify(result, null, 2);
                } catch (e) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times"></i> JSON parse error: ${e.message}
                        </div>
                    `;
                    resultsDiv.textContent = 'Raw response:\n' + text;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times"></i> Network error: ${error.message}
                    </div>
                `;
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = 'Error: ' + error.message;
            }
        }
    </script>
</body>
</html>